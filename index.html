<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Renta PN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab {
            border-bottom-color: transparent;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid transparent;
        }
        .status-pendiente { background-color: #fef9c3; color: #854d0e; border-color: #fde047;}
        .status-conciliado { background-color: #dcfce7; color: #166534; border-color: #86efac;}
        .status-descartado { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5;}
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #f9fafb;
        }
        .sort-icon {
            display: inline-block;
            width: 1em;
            text-align: center;
            color: #9ca3af;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* New styles for better layout and text wrapping */
        .table-container, .overflow-x-auto {
            overflow-x: visible;
        }
        table {
            table-layout: fixed;
            width: 100%;
        }
        td, th {
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <!-- Capa de autenticación -->
    <div id="auth-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[200] flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Acceso Privado</h2>
            <p class="text-center text-gray-500 mb-6">Ingresa la contraseña para continuar.</p>
            <form id="auth-form">
                <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Contraseña">
                <p id="auth-error" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-4 transition-colors">
                    Acceder
                </button>
            </form>
        </div>
    </div>

    <!-- Contenido principal de la app (inicialmente oculto) -->
    <div id="app-container" class="hidden">
        <div id="notification-area" class="fixed top-5 right-5 z-[100] w-full max-w-sm"></div>
        <!-- Widened container for more space -->
        <div class="mx-auto px-4 sm:px-6 lg:px-8 max-w-screen-xl">
            <!-- Encabezado -->
            <header class="bg-white p-6 rounded-xl shadow-md mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Asistente Pro-Renta PN</h1>
                        <p class="text-gray-500 mt-1">Herramienta para consolidar y clasificar información tributaria.</p>
                        <div id="contribuyente-info" class="hidden mt-4 bg-blue-50 border border-blue-200 p-3 rounded-lg">
                            <p class="text-sm font-medium text-blue-800">Contribuyente</p>
                            <p id="contribuyente-nombre" class="text-lg font-bold text-blue-900"></p>
                            <p id="contribuyente-nit" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                     <div class="mt-4 md:mt-0">
                        <div class="flex items-center flex-wrap gap-2">
                            <label id="upload-label" for="file-upload" class="flex items-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg cursor-pointer transition-all duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload-cloud"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                                <span>Cargar</span>
                            </label>
                            <input id="file-upload" type="file" class="hidden" multiple accept=".csv,.xls,.xlsx,.pdf,.png,.jpg,.jpeg">
                            
                            <button id="export-gem-button" class="hidden flex items-center gap-2 bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 px-4 rounded-lg cursor-pointer transition-all duration-300">
                                <span>Exportar para GEM</span>
                            </button>
                            <button id="export-button" class="hidden flex items-center gap-2 bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg cursor-pointer transition-all duration-300">
                                <span>Exportar Estado</span>
                            </button>
                            <button id="reset-button" class="hidden flex items-center gap-3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg cursor-pointer transition-all duration-300">
                               <span>Limpiar</span>
                            </button>
                        </div>
                        <p id="upload-text" class="text-xs text-gray-400 mt-2 text-center md:text-left">Sube reportes, PDFs, imágenes, etc.</p>
                    </div>
                </div>
            </header>

            <!-- Estado Cero (Inicial) -->
            <div id="estado-cero" class="text-center bg-white p-10 rounded-xl shadow-md">
                <div id="loader" class="mx-auto mb-4 hidden"></div>
                <svg id="upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-stack mx-auto text-blue-500 mb-4"><path d="M16 22h2a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v3"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4 12a2 2 0 1 0 0 4h12a2 2 0 1 0 0-4Z"/><path d="M4 18a2 2 0 1 0 0 4h12a2 2 0 1 0 0-4Z"/></svg>
                <h2 id="estado-cero-titulo" class="text-xl font-bold text-gray-700">Listo para comenzar.</h2>
                <p id="estado-cero-mensaje" class="text-gray-500 mt-2">La base de datos para este caso está actualmente en cero.<br>Por favor, adjunta los documentos necesarios para poder iniciar el análisis.</p>
            </div>

            <!-- Contenido Principal (Inicialmente oculto) -->
            <main id="main-content" class="bg-white p-6 rounded-xl shadow-md hidden">
                <!-- Pestañas y Tablas -->
                <div id="tab-container">
                     <div class="border-b border-gray-200 mb-6">
                        <nav id="tabs" class="flex flex-wrap space-x-8 -mb-px">
                            <button data-tab="estados-financieros" class="tab tab-active text-base py-4 px-1 border-b-2 font-medium">Estados Financieros</button>
                            <button data-tab="resumen" class="tab text-base text-gray-500 py-4 px-1 border-b-2 font-medium">Resumen Detallado</button>
                            <button data-tab="ingresos" class="tab text-base text-gray-500 py-4 px-1 border-b-2 font-medium">Ingresos</button>
                            <button data-tab="deducciones" class="tab text-base text-gray-500 py-4 px-1 border-b-2 font-medium">Costos y Deducciones</button>
                            <button data-tab="patrimonio" class="tab text-base text-gray-500 py-4 px-1 border-b-2 font-medium">Patrimonio</button>
                            <button data-tab="retenciones" class="tab text-base text-gray-500 py-4 px-1 border-b-2 font-medium">Retenciones</button>
                            <button data-tab="archivos" class="tab text-base text-gray-500 py-4 px-1 border-b-2 font-medium">Archivos</button>
                        </nav>
                    </div>
                    <div id="tab-content">
                        <div id="estados-financieros" class="tab-pane p-4 space-y-8"></div>
                        <div id="resumen" class="tab-pane hidden p-4 space-y-8"></div>
                        <div id="ingresos" class="tab-pane hidden">
                            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-between items-center">
                                <p class="text-sm text-gray-600">Registros agrupados por Concepto y Fuente. Haz clic para ver el detalle.</p>
                                <div class="flex gap-2">
                                    <button class="add-manual-btn whitespace-nowrap bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-target="ingresos">Añadir Manualmente</button>
                                    <button class="concile-all-btn whitespace-nowrap bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" data-target="ingresos">Conciliar Todo</button>
                                </div>
                            </div>
                            <div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">Descripción</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Valor Total</th></tr></thead><tbody id="ingresos-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                            <div id="ingresos-summary" class="mt-8 border-t pt-6"></div>
                        </div>
                        <div id="deducciones" class="tab-pane hidden">
                             <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-between items-center">
                                <p class="text-sm text-gray-600">Registros agrupados por Concepto y Fuente. Haz clic para ver el detalle.</p>
                                <div class="flex gap-2">
                                    <button class="add-manual-btn whitespace-nowrap bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-target="deducciones">Añadir Manualmente</button>
                                    <button class="concile-all-btn whitespace-nowrap bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" data-target="deducciones">Conciliar Todo</button>
                                </div>
                            </div>
                            <div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/5">Descripción</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-2/5">Valor Total</th></tr></thead><tbody id="deducciones-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                            <div id="deducciones-summary" class="mt-8 border-t pt-6"></div>
                        </div>
                        <div id="patrimonio" class="tab-pane hidden">
                            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-between items-center">
                                <input type="text" class="filter-input w-full md:w-auto flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" data-target="patrimonio-body" data-col="2" placeholder="Filtrar por descripción...">
                                 <div class="flex gap-2">
                                    <button class="add-manual-btn whitespace-nowrap bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-target="patrimonio">Añadir Manualmente</button>
                                    <button class="concile-all-btn whitespace-nowrap bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" data-target="patrimonio">Conciliar Todo</button>
                                </div>
                            </div>
                            <div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-type="patrimonio" data-key="tipo">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th><th class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-type="patrimonio" data-key="descripcion">Descripción</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Fiscal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuente</th></tr></thead><tbody id="patrimonio-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                            <div id="patrimonio-summary" class="mt-8 border-t pt-6"></div>
                        </div>
                        <div id="retenciones" class="tab-pane hidden">
                            <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-4 justify-between items-center">
                                <input type="text" class="filter-input w-full md:w-auto flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" data-target="retenciones-body" data-col="0" placeholder="Filtrar por tercero...">
                                <div class="flex gap-2">
                                    <button class="add-manual-btn whitespace-nowrap bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-target="retenciones">Añadir Manualmente</button>
                                    <button class="concile-all-btn whitespace-nowrap bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg" data-target="retenciones">Conciliar Todo</button>
                                </div>
                            </div>
                            <div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-type="retenciones" data-key="tercero">Tercero<span class="sort-icon"></span></th><th class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-type="retenciones" data-key="concepto">Concepto<span class="sort-icon"></span></th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuente</th></tr></thead><tbody id="retenciones-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                            <div id="retenciones-summary" class="mt-8 border-t pt-6"></div>
                        </div>
                         <div id="archivos" class="tab-pane hidden">
                            <div class="table-container"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre de Archivo</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Carga</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th></tr></thead><tbody id="archivos-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para entrada manual -->
    <div id="manual-entry-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto transform scale-95">
            <div class="p-6">
                <div class="flex justify-between items-center pb-3">
                    <p id="modal-title" class="text-2xl font-bold">Añadir Entrada Manual</p>
                    <div id="modal-close" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>
                <form id="modal-form" class="space-y-4"></form>
                <div class="flex justify-end pt-6">
                    <button id="modal-save" class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para revisión de IA -->
    <div id="ai-review-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-lg z-50 overflow-y-auto transform scale-95">
            <div class="p-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">Resultados de la IA</p>
                    <div id="ai-modal-close" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-2">Por favor, revisa y corrige los valores extraídos antes de guardarlos.</p>
                <form id="ai-review-form" class="space-y-4 mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Nombre Contribuyente</label><input type="text" id="ai-review-nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">NIT</label><input type="text" id="ai-review-nit" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div class="md:col-span-2"><hr></div>
                    <div class="font-medium text-gray-500 text-sm md:col-span-2">Patrimonio</div>
                    <div><label class="block text-sm font-medium text-gray-700">Valor Activo/Pasivo</label><input type="number" id="ai-review-patrimonioValor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Categoría Activo</label><select id="ai-review-patrimonioCategoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></select></div>
                    <div class="md:col-span-2"><hr></div>
                    <div class="font-medium text-gray-500 text-sm md:col-span-2">Rentas de Trabajo (Form. 220)</div>
                    <div><label class="block text-sm font-medium text-gray-700">Pagador / Agente Retenedor</label><input type="text" id="ai-review-agenteRetenedor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Salarios (Casilla 36)</label><input type="number" id="ai-review-salarios" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Prestaciones Sociales (Casilla 42)</label><input type="number" id="ai-review-prestaciones" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                     <div><label class="block text-sm font-medium text-gray-700">Retención por Salarios (Casilla 60)</label><input type="number" id="ai-review-retencionSalarios" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div class="md:col-span-2"><hr></div>
                    <div class="font-medium text-gray-500 text-sm md:col-span-2">Seguridad Social (PILA / Form. 220)</div>
                    <div><label class="block text-sm font-medium text-gray-700">Aporte Salud (Casilla 53)</label><input type="number" id="ai-review-aporteSalud" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Aporte Pensión (Casilla 54)</label><input type="number" id="ai-review-aportePension" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div class="md:col-span-2"><hr></div>
                    <div class="font-medium text-gray-500 text-sm md:col-span-2">Datos Bancarios (Adicionales)</div>
                    <div><label class="block text-sm font-medium text-gray-700">Rendimientos</label><input type="number" id="ai-review-rendimientos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Retención Rendimientos</label><input type="number" id="ai-review-retencionRendimientos" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">GMF (4x1000)</label><input type="number" id="ai-review-gmf" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Intereses Pagados (Créditos)</label><input type="number" id="ai-review-interesesPagados" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                </form>
                <div class="flex justify-end pt-6 mt-4 border-t">
                    <button id="ai-modal-cancel" class="mr-2 px-4 bg-gray-200 p-3 rounded-lg text-gray-800 hover:bg-gray-300">Cancelar</button>
                    <button id="ai-modal-save" class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-600">Guardar y Clasificar</button>
                </div>
            </div>
        </div>
    </div>

     <!-- Modal for API Key -->
    <div id="api-key-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden z-[150]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 transform scale-95">
            <div class="p-6">
                <div class="pb-3">
                    <p class="text-2xl font-bold">Configuración Requerida</p>
                </div>
                <p class="text-sm text-gray-600 mb-4">Para usar las funciones de IA, necesitas una API Key de Google AI Studio. Es gratis y fácil de obtener.</p>
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700">Tu API Key de Gemini</label>
                    <input type="password" id="api-key-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Pega tu clave aquí">
                    <p class="text-xs text-gray-500 mt-1">La clave se guardará de forma segura en tu navegador.</p>
                </div>
                 <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline text-sm mt-2 inline-block">¿No tienes una clave? Obtenla aquí.</a>
                <div class="flex justify-end pt-6 mt-4 border-t">
                    <button id="api-key-save" class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-600">Guardar Clave</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Librerías JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        let fichaContribuyente = {
            nombre: null,
            nit: null,
            documentos: [],
            ingresos: [],
            deducciones: [],
            patrimonio: [],
            retenciones: []
        };
        
        let sortState = {};
        let isInitialLoad = true;
        let latestFileName = null; 
        let expandedGroupIds = new Set(); // Stores the IDs of expanded groups

        const categorias = {
            ingresos: ['Renta Laboral', 'Honorarios', 'Renta de Capital', 'Renta no Laboral', 'No Constitutivo', 'Otro'],
            deducciones: ['Costo/Gasto Procedente', 'Deducción Salud', 'Deducción Vivienda', 'Aportes AFC/Pensiones', 'Dependientes', 'Donaciones', 'GMF (4x1000)', 'Beneficio Facturación', 'Otro'],
            patrimonio: ['Bancos y efectivo', 'Inversiones', 'Cuentas por cobrar', 'Inventarios', 'Vehículos', 'Bienes inmuebles y/o acciones', 'Otros activos']
        };
        const estados = ['Pendiente', 'Conciliado', 'Descartado'];

        document.addEventListener('DOMContentLoaded', () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
            setupAuth();
        });
        
        function setupAuth() {
            const authForm = document.getElementById('auth-form');
            const passwordInput = document.getElementById('password-input');
            const authError = document.getElementById('auth-error');
            
            const ACCESS_PASSWORD = "pro-renta-2025"; 

            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (passwordInput.value === ACCESS_PASSWORD) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('app-container').classList.remove('hidden');
                    initializeApp();
                } else {
                    authError.textContent = 'Contraseña incorrecta.';
                    passwordInput.value = '';
                }
            });
        }
        
        function initializeApp() {
            enterEstadoCero();
            setupTabs();
            setupFileInput();
            setupResetButton();
            setupTableControls();
            setupModal();
            setupAiReviewModal();
            checkAndRequestApiKey();
        }

        function checkAndRequestApiKey() {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                const modal = document.getElementById('api-key-modal');
                modal.classList.remove('hidden');
                modal.querySelector('.modal-content').classList.remove('scale-95');

                document.getElementById('api-key-save').addEventListener('click', () => {
                    const keyInput = document.getElementById('api-key-input');
                    if (keyInput.value && keyInput.value.trim() !== '') {
                        localStorage.setItem('geminiApiKey', keyInput.value.trim());
                        modal.classList.add('hidden');
                        showNotification('API Key guardada correctamente.', 'success');
                    } else {
                        showNotification('Por favor, ingresa una API Key válida.', 'error');
                    }
                }, { once: true });
            }
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active', 'text-gray-500'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                    tab.classList.add('tab-active');
                    tab.classList.remove('text-gray-500');
                    const targetPane = document.getElementById(tab.dataset.tab);
                    if (targetPane) {
                        targetPane.classList.remove('hidden');
                    }

                    if (tab.dataset.tab === 'resumen') {
                        renderOverallSummary();
                    } else if (tab.dataset.tab === 'estados-financieros') {
                        renderFinancialStatements();
                    } else if (tab.dataset.tab === 'archivos') {
                        populateArchivosTab();
                    }
                    else {
                        updateSummary();
                    }
                });
            });
        }

        function setupFileInput() {
             document.getElementById('file-upload').addEventListener('change', async (event) => {
                const files = Array.from(event.target.files);
                if (files.length > 0) {

                    const newFiles = files.filter(f => !fichaContribuyente.documentos.some(doc => doc.file.name === f.name));
                    if (newFiles.length < files.length) {
                        showNotification('Se han omitido archivos con nombres duplicados.', 'warning');
                    }
                    
                    if (newFiles.length === 0) {
                        event.target.value = null; 
                        return;
                    }

                    latestFileName = newFiles[newFiles.length - 1].name;

                    showLoader(true, isInitialLoad);
                    await processFiles(newFiles);
                    showLoader(false, isInitialLoad);
                    
                    if (isInitialLoad && (fichaContribuyente.ingresos.length > 0 || fichaContribuyente.deducciones.length > 0 || fichaContribuyente.patrimonio.length > 0)) {
                        exitEstadoCero();
                        isInitialLoad = false;
                    }

                    updateUploadedFilesList();
                    document.getElementById('reset-button').classList.remove('hidden');
                    document.getElementById('export-button').classList.remove('hidden');
                    document.getElementById('export-gem-button').classList.remove('hidden');

                    populateAllTables();
                    event.target.value = null; 
                }
            });
        }
        
        function updateUploadedFilesList() {
             const fileNames = fichaContribuyente.documentos.map(doc => doc.file.name).join(', ');
             document.getElementById('upload-text').textContent = fileNames ? `Archivos cargados: ${fileNames}` : 'Sube reportes, PDFs, imágenes, etc.';
        }

        function setupResetButton() {
            document.getElementById('reset-button').addEventListener('click', resetApplication);
            document.getElementById('export-button').addEventListener('click', exportToExcel);
            document.getElementById('export-gem-button').addEventListener('click', exportForGem);
        }

        function setupTableControls() {
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('keyup', (event) => {
                    const searchTerm = event.target.value.toLowerCase();
                    const tableBodyId = event.target.dataset.target;
                    const colIndex = parseInt(event.target.dataset.col, 10);
                    const tableBody = document.getElementById(tableBodyId);
                    
                    tableBody.querySelectorAll('tr:not(.detail-row)').forEach(row => {
                        const cell = row.querySelectorAll('td')[colIndex];
                        if (cell) {
                            const cellText = cell.textContent || cell.innerText;
                            row.style.display = cellText.toLowerCase().includes(searchTerm) ? '' : 'none';
                        }
                    });
                });
            });
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', (event) => {
                    const type = header.dataset.type;
                    const key = header.dataset.key;
                    if (!sortState[type] || sortState[type].key !== key) {
                        sortState[type] = { key, dir: 'asc' };
                    } else {
                        sortState[type].dir = sortState[type].dir === 'asc' ? 'desc' : 'asc';
                    }
                    sortAndRepopulateTables();
                    updateSortIcons();
                });
            });
            document.querySelectorAll('.concile-all-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.target;
                    if (fichaContribuyente[type]) {
                        fichaContribuyente[type].forEach(item => {
                            item.estado = 'Conciliado';
                        });
                        populateAllTables();
                    }
                });
            });
            document.querySelectorAll('.add-manual-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.target;
                    openManualEntryModal(type);
                });
            });
            document.getElementById('archivos-body').addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-file-btn')) {
                    const fileName = event.target.dataset.filename;
                    deleteFileAndData(fileName);
                }
            });
            ['ingresos-body', 'deducciones-body'].forEach(id => {
                const body = document.getElementById(id);
                if (body) {
                     body.addEventListener('click', e => {
                        const header = e.target.closest('.group-header');
                        if (!header) return;

                        const groupId = header.dataset.groupId;

                        const statusButton = e.target.closest('.status-group-btn');
                        if (statusButton) {
                            e.stopPropagation();
                            const type = statusButton.dataset.type;
                            const concepto = statusButton.dataset.concepto;
                            const fuente = statusButton.dataset.fuente;
                            const newStatus = statusButton.dataset.status;
                            updateGroupStatus(type, concepto, fuente, newStatus);
                            return;
                        }
                        
                        const container = document.querySelector(`.detail-container[data-group-id="${groupId}"]`);
                        const arrow = header.querySelector('.group-arrow');

                        if (container) {
                            if (container.classList.contains('hidden')) {
                                expandedGroupIds.add(groupId);
                            } else {
                                expandedGroupIds.delete(groupId);
                            }
                            container.classList.toggle('hidden');
                        }
                        if (arrow) arrow.classList.toggle('rotate-90');
                    });
                    body.addEventListener('change', e => {
                        const selector = e.target.closest('.group-category-selector');
                        if (!selector || selector.value === "") return;
                        const type = selector.dataset.type;
                        const concepto = selector.dataset.concepto;
                        const fuente = selector.dataset.fuente;
                        const newCategory = selector.value;
                        updateGroupCategory(type, concepto, fuente, newCategory);
                        selector.value = "";
                    });
                }
            });
        }
        
        function updateGroupCategory(type, concepto, fuente, newCategory) {
            if (!fichaContribuyente[type]) return;
            fichaContribuyente[type].forEach(item => {
                if ((item.concepto || 'Sin Concepto') === concepto && (item.fuente || 'Sin Fuente') === fuente) {
                    item.categoria = newCategory;
                }
            });
            populateAllTables();
            showNotification(`Categoría del grupo "${concepto}" actualizada a "${newCategory}".`, 'success');
        }

        function updateGroupStatus(type, concepto, fuente, newStatus) {
            if (!fichaContribuyente[type]) return;
            let statusText = '';
            switch(newStatus) {
                case 'Conciliado': statusText = 'conciliado'; break;
                case 'Pendiente': statusText = 'marcado como pendiente'; break;
                case 'Descartado': statusText = 'descartado'; break;
            }
            fichaContribuyente[type].forEach(item => {
                if ((item.concepto || 'Sin Concepto') === concepto && (item.fuente || 'Sin Fuente') === fuente) {
                    item.estado = newStatus;
                }
            });
            populateAllTables();
            showNotification(`Grupo "${concepto}" ${statusText}.`, 'success');
        }

        function deleteFileAndData(fileName) {
            fichaContribuyente.documentos = fichaContribuyente.documentos.filter(doc => doc.file.name !== fileName);
            ['ingresos', 'deducciones', 'patrimonio', 'retenciones'].forEach(type => {
                fichaContribuyente[type] = fichaContribuyente[type].filter(item => item.fuente !== fileName);
            });
            populateAllTables();
            updateUploadedFilesList();
            if (fichaContribuyente.documentos.length === 0) {
                resetApplication();
            }
        }

        function setupModal() {
            const modal = document.getElementById('manual-entry-modal');
            const closeBtn = document.getElementById('modal-close');
            const overlay = modal.querySelector('.modal-overlay');
            const closeModal = () => {
                modal.classList.add('hidden');
                modal.querySelector('.modal-content').classList.add('scale-95');
            };
            closeBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") closeModal();
            });
        }

        function setupAiReviewModal() {
            const modal = document.getElementById('ai-review-modal');
            const closeBtn = document.getElementById('ai-modal-close');
            const cancelBtn = document.getElementById('ai-modal-cancel');
            const overlay = modal.querySelector('.modal-overlay');

            const closeModal = () => {
                modal.classList.add('hidden');
                modal.querySelector('.modal-content').classList.add('scale-95');
            };

            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            overlay.addEventListener('click', closeModal);
        }

        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            if (!notificationArea) return;
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg text-white shadow-lg mb-2 transform transition-all duration-300 ease-out`;
            notification.classList.add(colors[type]);
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            notification.textContent = message;
            notificationArea.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }
        
        function updateContribuyenteInfoUI() {
            if(fichaContribuyente.nit && fichaContribuyente.nombre) {
                document.getElementById('contribuyente-nombre').textContent = fichaContribuyente.nombre;
                document.getElementById('contribuyente-nit').textContent = `NIT: ${fichaContribuyente.nit}`;
                document.getElementById('contribuyente-info').classList.remove('hidden');
            }
        }

        function openManualEntryModal(type) {
            const modal = document.getElementById('manual-entry-modal');
            const form = document.getElementById('modal-form');
            const title = document.getElementById('modal-title');
            const saveBtn = document.getElementById('modal-save');
            form.innerHTML = ''; 
            title.textContent = `Añadir a ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            let formHtml = '';
            switch (type) {
                case 'ingresos':
                    formHtml = `
                        <div><label class="block text-sm font-medium text-gray-700">Tercero</label><input type="text" id="manual-tercero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Concepto</label><input type="text" id="manual-concepto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Valor</label><input type="number" id="manual-valor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required></div>
                        <div><label class="block text-sm font-medium text-gray-700">Categoría</label><select id="manual-categoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">${categorias.ingresos.map(c => `<option>${c}</option>`).join('')}</select></div>
                    `;
                    break;
                case 'deducciones':
                      formHtml = `
                        <div><label class="block text-sm font-medium text-gray-700">Tercero</label><input type="text" id="manual-tercero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Concepto</label><input type="text" id="manual-concepto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Base Cálculo (Opcional)</label><input type="number" id="manual-base" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Valor</label><input type="number" id="manual-valor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required></div>
                        <div><label class="block text-sm font-medium text-gray-700">Categoría</label><select id="manual-categoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">${categorias.deducciones.map(c => `<option>${c}</option>`).join('')}</select></div>
                    `;
                    break;
                case 'patrimonio':
                    const patrimonioOptions = categorias.patrimonio.map(c => `<option>${c}</option>`).join('');
                    formHtml = `
                        <div><label class="block text-sm font-medium text-gray-700">Tipo</label><select id="manual-tipo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"><option>Activo</option><option>Pasivo</option></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Categoría</label><select id="manual-categoria" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">${patrimonioOptions}</select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Descripción</label><input type="text" id="manual-descripcion" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Valor Fiscal</label><input type="number" id="manual-valor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required></div>
                    `;
                    break;
                case 'retenciones':
                    formHtml = `
                        <div><label class="block text-sm font-medium text-gray-700">Tercero</label><input type="text" id="manual-tercero" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Concepto</label><input type="text" id="manual-concepto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Valor</label><input type="number" id="manual-valor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required></div>
                    `;
                    break;
            }
            form.innerHTML = formHtml;
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.addEventListener('click', () => saveManualEntry(type));
            modal.classList.remove('hidden');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function saveManualEntry(type) {
            const valor = parseFloat(document.getElementById('manual-valor').value);
            if (isNaN(valor)) {
                showNotification('El campo "Valor" es obligatorio y debe ser un número.', 'error');
                return;
            }
            let newItem = {
                valor: valor,
                estado: 'Pendiente',
                fuente: 'Entrada Manual'
            };
            switch(type) {
                case 'ingresos':
                    newItem.tercero = document.getElementById('manual-tercero').value;
                    newItem.concepto = document.getElementById('manual-concepto').value;
                    newItem.categoria = document.getElementById('manual-categoria').value;
                    break;
                case 'deducciones':
                    newItem.tercero = document.getElementById('manual-tercero').value;
                    newItem.concepto = document.getElementById('manual-concepto').value;
                    newItem.base = parseFloat(document.getElementById('manual-base').value) || null;
                    newItem.categoria = document.getElementById('manual-categoria').value;
                    break;
                case 'patrimonio':
                    newItem.tipo = document.getElementById('manual-tipo').value;
                    newItem.categoria = document.getElementById('manual-categoria').value;
                    newItem.descripcion = document.getElementById('manual-descripcion').value;
                     if (newItem.tipo === 'Pasivo') {
                        newItem.categoria = 'Deudas';
                    }
                    break;
                case 'retenciones':
                      newItem.tercero = document.getElementById('manual-tercero').value;
                      newItem.concepto = document.getElementById('manual-concepto').value;
                    break;
            }
            fichaContribuyente[type].push(newItem);
            populateAllTables();
            document.getElementById('manual-entry-modal').classList.add('hidden');
        }
        
        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '');
            for (const type in sortState) {
                if(sortState[type] && sortState[type].key) {
                    const { key, dir } = sortState[type];
                    const header = document.querySelector(`.sortable-header[data-type="${type}"][data-key="${key}"]`);
                    if (header) {
                        const icon = header.querySelector('.sort-icon');
                        icon.textContent = dir === 'asc' ? ' ▲' : ' ▼';
                        icon.style.color = '#3b82f6';
                    }
                }
            }
        }

        function sortAndRepopulateTables() {
            for(const type in sortState) {
                if(sortState[type] && sortState[type].key && fichaContribuyente[type]) {
                    const { key, dir } = sortState[type];
                    const multiplier = dir === 'asc' ? 1 : -1;
                    fichaContribuyente[type].sort((a, b) => {
                        const valA = a[key] || '';
                        const valB = b[key] || '';
                        if (typeof valA === 'number' && typeof valB === 'number') {
                            return (valA - valB) * multiplier;
                        }
                        return valA.localeCompare(valB) * multiplier;
                    });
                }
            }
            populateAllTables();
        }

        function resetApplication() {
            fichaContribuyente = { nombre: null, nit: null, documentos: [], ingresos: [], deducciones: [], patrimonio: [], retenciones: [] };
            sortState = {};
            isInitialLoad = true;
            expandedGroupIds.clear();
            populateAllTables();
            updateSortIcons();
            document.querySelectorAll('.filter-input').forEach(input => input.value = '');
            document.getElementById('contribuyente-info').classList.add('hidden');
            enterEstadoCero();
            const fileInput = document.getElementById('file-upload');
            fileInput.value = '';
            document.getElementById('upload-text').textContent = 'Sube reportes, PDFs, imágenes, etc.';
            document.getElementById('reset-button').classList.add('hidden');
            document.getElementById('export-button').classList.add('hidden');
            document.getElementById('export-gem-button').classList.add('hidden');
        }

        function showLoader(show, isInitial) {
             if (isInitial) {
                document.getElementById('loader').classList.toggle('hidden', !show);
                document.getElementById('upload-icon').classList.toggle('hidden', show);
                document.getElementById('estado-cero-titulo').textContent = show ? 'Procesando archivos...' : 'Listo para comenzar.';
                document.getElementById('estado-cero-mensaje').textContent = show ? 'Por favor, espera un momento.' : 'La base de datos para este caso está actualmente en cero.<br>Por favor, adjunta los documentos necesarios para poder iniciar el análisis.';
            }
        }

        function enterEstadoCero() {
            document.getElementById('estado-cero').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        }

        function exitEstadoCero() {
            document.getElementById('estado-cero').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            renderFinancialStatements(); 
        }

        function exportToExcel() {
            if (fichaContribuyente.documentos.length === 0 && fichaContribuyente.ingresos.length === 0) {
                showNotification("No hay datos para exportar.", "warning");
                return;
            }

            const wb = XLSX.utils.book_new();

            const metadata = [{
                nombre: fichaContribuyente.nombre,
                nit: fichaContribuyente.nit,
                version: "1.0"
            }];
            const ws_meta = XLSX.utils.json_to_sheet(metadata);
            XLSX.utils.book_append_sheet(wb, ws_meta, "Metadata");

            const ws_ingresos = XLSX.utils.json_to_sheet(fichaContribuyente.ingresos);
            XLSX.utils.book_append_sheet(wb, ws_ingresos, "Ingresos");

            const ws_deducciones = XLSX.utils.json_to_sheet(fichaContribuyente.deducciones);
            XLSX.utils.book_append_sheet(wb, ws_deducciones, "Deducciones");

            const ws_patrimonio = XLSX.utils.json_to_sheet(fichaContribuyente.patrimonio);
            XLSX.utils.book_append_sheet(wb, ws_patrimonio, "Patrimonio");

            const ws_retenciones = XLSX.utils.json_to_sheet(fichaContribuyente.retenciones);
            XLSX.utils.book_append_sheet(wb, ws_retenciones, "Retenciones");
            
            const fileName = `estado-pro-renta_${(fichaContribuyente.nombre || 'export').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification("Exportación de estado completada.", "success");
        }
        
        function exportForGem() {
            const consolidated = [];
            
            const formatDesc = (item, defaultConcept) => {
                if(item.descripcion) return item.descripcion;
                if(item.tercero && item.concepto) return `${item.tercero} - ${item.concepto}`;
                if(item.tercero) return item.tercero;
                if(item.concepto) return item.concepto;
                return defaultConcept || 'N/A';
            }

            fichaContribuyente.ingresos.filter(i => i.estado === 'Conciliado').forEach(item => {
                consolidated.push({
                    'Tipo': 'Ingreso',
                    'Categoria': item.categoria || 'N/A',
                    'Descripcion': formatDesc(item, 'Ingreso General'),
                    'Valor': item.valor
                });
            });

            fichaContribuyente.deducciones.filter(i => i.estado === 'Conciliado').forEach(item => {
                consolidated.push({
                    'Tipo': 'Deducción',
                    'Categoria': item.categoria || 'N/A',
                    'Descripcion': formatDesc(item, 'Costo/Gasto General'),
                    'Valor': item.valor
                });
            });

            fichaContribuyente.patrimonio.filter(i => i.estado === 'Conciliado').forEach(item => {
                consolidated.push({
                    'Tipo': item.tipo, 
                    'Categoria': item.categoria,
                    'Descripcion': formatDesc(item),
                    'Valor': item.valor
                });
            });

            fichaContribuyente.retenciones.filter(i => i.estado === 'Conciliado').forEach(item => {
                consolidated.push({
                    'Tipo': 'Retención a Favor',
                    'Categoria': 'Retenciones',
                    'Descripcion': formatDesc(item, 'Retención'),
                    'Valor': item.valor
                });
            });

            if (consolidated.length === 0) {
                showNotification("No hay datos conciliados para exportar a GEM.", "warning");
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(consolidated);
            XLSX.utils.book_append_sheet(wb, ws, "Datos_Conciliados");

            const fileName = `export_gem_${(fichaContribuyente.nombre || 'export').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification("Exportación para GEM completada.", "success");
        }


        function importFromExcelState(workbook) {
            resetApplication();

            const metaSheet = workbook.Sheets['Metadata'];
            if (metaSheet) {
                const metadata = XLSX.utils.sheet_to_json(metaSheet)[0];
                if (metadata) {
                    fichaContribuyente.nombre = metadata.nombre || null;
                    fichaContribuyente.nit = metadata.nit || null;
                }
            }
            
            const sanitizeNumber = (value) => (value !== null && value !== undefined && value !== '') ? parseFloat(value) : null;

            const importSheet = (sheetName, targetArray) => {
                const sheet = workbook.Sheets[sheetName];
                if (sheet) {
                    const data = XLSX.utils.sheet_to_json(sheet);
                    data.forEach(item => {
                        if ('valor' in item) item.valor = sanitizeNumber(item.valor);
                        if ('base' in item) item.base = sanitizeNumber(item.base);
                        targetArray.push(item);
                    });
                }
            };

            importSheet('Ingresos', fichaContribuyente.ingresos);
            importSheet('Deducciones', fichaContribuyente.deducciones);
            importSheet('Patrimonio', fichaContribuyente.patrimonio);
            importSheet('Retenciones', fichaContribuyente.retenciones);

            if (fichaContribuyente.ingresos.length > 0 || fichaContribuyente.deducciones.length > 0 || fichaContribuyente.patrimonio.length > 0) {
                 if (isInitialLoad) {
                    exitEstadoCero();
                    isInitialLoad = false;
                }
                document.getElementById('reset-button').classList.remove('hidden');
                document.getElementById('export-button').classList.remove('hidden');
                document.getElementById('export-gem-button').classList.remove('hidden');
            }
            updateContribuyenteInfoUI();
            populateAllTables();
        }

        async function processFiles(files) {
            const newFileObjects = files.map(file => ({ file: file, uploadedAt: new Date() }));

            const processingPromises = newFileObjects.map(doc => {
                return new Promise(async (resolve) => {
                    const file = doc.file;
                    const fileName = file.name;
                    let success = false;

                    try {
                        if (file.type.startsWith('image/')) {
                            await processImageWithAI(file, fileName);
                            success = true;
                            if (success) fichaContribuyente.documentos.push(doc);
                            resolve();
                        } else { 
                            const reader = new FileReader();
                            reader.onload = async (e) => {
                                try {
                                    const buffer = e.target.result;
                                    if (file.type === 'application/pdf') {
                                        if (!navigator.onLine) {
                                            showNotification('Se requiere conexión a internet para procesar archivos PDF con IA.', 'error');
                                            return;
                                        }
                                        const pdfData = new Uint8Array(buffer);
                                        await processPdfWithAI(pdfData, fileName);
                                        success = true;
                                    } else { 
                                        const data = new Uint8Array(buffer);
                                        const workbook = XLSX.read(data, { type: 'array' });

                                        if (workbook.SheetNames.includes('Metadata') && workbook.SheetNames.includes('Ingresos')) {
                                            importFromExcelState(workbook);
                                            showNotification(`Archivo de estado "${fileName}" importado.`, "success");
                                        } else {
                                            const firstSheetName = workbook.SheetNames[0];
                                            const worksheet = workbook.Sheets[firstSheetName];
                                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false });
                                            processSheetData(json, fileName);
                                            success = true;
                                        }
                                    }
                                } catch (error) {
                                    console.error("Error al procesar el buffer del archivo:", fileName, error);
                                    showNotification(`Error al procesar: ${fileName}. Formato no soportado o archivo corrupto.`, 'error');
                                } finally {
                                    if (success) {
                                        fichaContribuyente.documentos.push(doc);
                                    }
                                    resolve();
                                }
                            };
                            reader.onerror = (error) => {
                                console.error("Error al leer el archivo:", fileName, error);
                                showNotification(`No se pudo leer el archivo: ${fileName}.`, 'error');
                                resolve();
                            };
                            reader.readAsArrayBuffer(file);
                        }
                    } catch (error) { 
                        console.error("Error al procesar el archivo de imagen:", fileName, error);
                        showNotification(`Error al procesar la imagen: ${fileName}.`, 'error');
                        resolve();
                    }
                });
            });
            await Promise.all(processingPromises);
        }
        
        async function processImageWithAI(file, fileName) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const base64Data = e.target.result.split(',')[1];
                        const data = await callGeminiForExtraction({
                            mimeType: file.type,
                            data: base64Data
                        });
                        if (data) {
                            openAiReviewModal(data, fileName);
                        }
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function processPdfWithAI(pdfData, fileName) {
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(' ');
            }
            const data = await callGeminiForExtraction(fullText);
            if (data) {
                openAiReviewModal(data, fileName);
            }
        }
        
        async function callGeminiForExtraction(input) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showNotification("API Key no encontrada. Por favor, configúrala para usar la IA.", "error");
                checkAndRequestApiKey();
                return null;
            }

            const patrimonioCategoriasStr = categorias.patrimonio.join("', '");
             const systemPrompt = `Eres un asistente contable experto en Colombia. Analiza el texto o la imagen de un documento financiero. Puede ser un certificado bancario, de vehículo, de un bien inmueble, una planilla de pago de seguridad social (PILA) o un Certificado de Ingresos y Retenciones (Formulario 220). Extrae los siguientes valores. Si un valor no se encuentra, omite la clave o déjalo en 0. El resultado DEBE ser un objeto JSON válido.
                 - contribuyente.nombre: Nombre del empleado.
                 - contribuyente.nit: NIT o número de identificación del empleado.
                 - agenteRetenedor: Nombre o Razón Social del pagador o agente retenedor.
                 - patrimonio.valor: El valor principal del activo o pasivo (ej. Saldo de cuenta, avalúo catastral, valor del vehículo, monto de la deuda).
                 - patrimonio.categoria: Clasifica el activo en UNA de las siguientes categorías: '${patrimonioCategoriasStr}'. Si es una deuda, ignora esta clasificación.
                 - salarios: El valor de "Pagos por salarios" (Casilla 36 del Formulario 220).
                 - prestaciones: El valor de "Pagos por prestaciones sociales" (Casilla 42 del Formulario 220).
                 - aporteSalud: El valor de "Aportes obligatorios por salud" (Casilla 53 del Formulario 220 o el total de Salud en una PILA).
                 - aportePension: El valor de "Aportes obligatorios a fondos de pensiones" (Casilla 54 del Formulario 220 o el total de Pensión en una PILA).
                 - retencionSalarios: El valor de "retención en la fuente por ingresos laborales" (Casilla 60 del Formulario 220).
                 - rendimientos: La "Base Gravable" de los "Rendimientos Financieros".
                 - retencionRendimientos: El "Valor Retención" de los "Rendimientos Financieros".
                 - gmf: El "Valor GMF" del "Gravamen a los Movimientos Financieros".
                 - interesesPagados: El valor de "Intereses Causados" o "Intereses Pagados".`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let parts;
            if (typeof input === 'string') {
                parts = [{ text: input }];
            } else { // It's an image object
                parts = [
                    { text: "Extrae los datos financieros de esta imagen." },
                    { inlineData: { mimeType: input.mimeType, data: input.data } }
                ];
            }

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            } catch (error) {
                console.error("Error calling Gemini API or parsing response:", error);
                showNotification("Error al procesar el documento con la IA. Revisa la consola.", 'error');
                return null;
            }
        }
        
        function openAiReviewModal(data, fileName) {
            const modal = document.getElementById('ai-review-modal');
            const patrimonioCategoriaSelect = document.getElementById('ai-review-patrimonioCategoria');
            
            patrimonioCategoriaSelect.innerHTML = categorias.patrimonio.map(c => `<option value="${c}">${c}</option>`).join('');
            
            document.getElementById('ai-review-nombre').value = data.contribuyente?.nombre || '';
            document.getElementById('ai-review-nit').value = data.contribuyente?.nit || '';
            document.getElementById('ai-review-patrimonioValor').value = data.patrimonio?.valor || 0;
            patrimonioCategoriaSelect.value = data.patrimonio?.categoria || 'Otros activos';

            // Populate Form 220 fields
            document.getElementById('ai-review-agenteRetenedor').value = data.agenteRetenedor || '';
            document.getElementById('ai-review-salarios').value = data.salarios || 0;
            document.getElementById('ai-review-prestaciones').value = data.prestaciones || 0;
            document.getElementById('ai-review-retencionSalarios').value = data.retencionSalarios || 0;

            // Populate other fields
            document.getElementById('ai-review-rendimientos').value = data.rendimientos || 0;
            document.getElementById('ai-review-retencionRendimientos').value = data.retencionRendimientos || 0;
            document.getElementById('ai-review-gmf').value = data.gmf || 0;
            document.getElementById('ai-review-interesesPagados').value = data.interesesPagados || 0;
            document.getElementById('ai-review-aporteSalud').value = data.aporteSalud || 0;
            document.getElementById('ai-review-aportePension').value = data.aportePension || 0;

            const saveBtn = document.getElementById('ai-modal-save');
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.addEventListener('click', () => saveAndClassifyAiData(fileName), { once: true });

            modal.classList.remove('hidden');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function saveAndClassifyAiData(fileName) {
            const agenteRetenedor = document.getElementById('ai-review-agenteRetenedor').value || 'Pagador No Identificado';

            const data = {
                contribuyente: {
                    nombre: document.getElementById('ai-review-nombre').value,
                    nit: document.getElementById('ai-review-nit').value
                },
                patrimonio: {
                    valor: parseFloat(document.getElementById('ai-review-patrimonioValor').value) || 0,
                    categoria: document.getElementById('ai-review-patrimonioCategoria').value
                },
                salarios: parseFloat(document.getElementById('ai-review-salarios').value) || 0,
                prestaciones: parseFloat(document.getElementById('ai-review-prestaciones').value) || 0,
                retencionSalarios: parseFloat(document.getElementById('ai-review-retencionSalarios').value) || 0,
                rendimientos: parseFloat(document.getElementById('ai-review-rendimientos').value) || 0,
                retencionRendimientos: parseFloat(document.getElementById('ai-review-retencionRendimientos').value) || 0,
                gmf: parseFloat(document.getElementById('ai-review-gmf').value) || 0,
                interesesPagados: parseFloat(document.getElementById('ai-review-interesesPagados').value) || 0,
                aporteSalud: parseFloat(document.getElementById('ai-review-aporteSalud').value) || 0,
                aportePension: parseFloat(document.getElementById('ai-review-aportePension').value) || 0
            };
            
            if (data.contribuyente.nombre && !fichaContribuyente.nombre) {
                fichaContribuyente.nombre = data.contribuyente.nombre;
                fichaContribuyente.nit = data.contribuyente.nit;
                updateContribuyenteInfoUI();
            }

            if (data.patrimonio.valor !== 0) {
                 const tipo = data.patrimonio.categoria === 'Deudas' ? 'Pasivo' : 'Activo';
                 fichaContribuyente.patrimonio.push({ 
                     tipo: tipo, 
                     categoria: data.patrimonio.categoria,
                     descripcion: `Activo/Pasivo de ${fileName}`, 
                     valor: data.patrimonio.valor, 
                     estado: 'Pendiente', 
                     fuente: fileName 
                });
            }

            // Classify Form 220 data
            if (data.salarios > 0) {
                 fichaContribuyente.ingresos.push({ tercero: agenteRetenedor, concepto: 'Salarios', valor: data.salarios, categoria: 'Renta Laboral', estado: 'Pendiente', fuente: fileName });
            }
            if (data.prestaciones > 0) {
                 fichaContribuyente.ingresos.push({ tercero: agenteRetenedor, concepto: 'Prestaciones Sociales', valor: data.prestaciones, categoria: 'Renta Laboral', estado: 'Pendiente', fuente: fileName });
            }
            if (data.retencionSalarios > 0) {
                 fichaContribuyente.retenciones.push({ tercero: agenteRetenedor, concepto: 'Retención por Salarios', valor: data.retencionSalarios, estado: 'Pendiente', fuente: fileName });
            }

            // Classify other data
            if (data.rendimientos > 0) {
                fichaContribuyente.ingresos.push({ tercero: 'Entidad Financiera', concepto: 'Rendimientos Financieros', valor: data.rendimientos, categoria: 'Renta de Capital', estado: 'Pendiente', fuente: fileName });
            }
            if (data.retencionRendimientos > 0) {
                fichaContribuyente.retenciones.push({ tercero: 'Entidad Financiera', concepto: 'Retención sobre Rendimientos', valor: data.retencionRendimientos, estado: 'Pendiente', fuente: fileName });
            }
            if (data.gmf > 0) {
                fichaContribuyente.deducciones.push({ tercero: 'Entidad Financiera', concepto: 'GMF (4x1000)', valor: data.gmf, categoria: 'GMF (4x1000)', estado: 'Pendiente', fuente: fileName });
            }
            if (data.interesesPagados > 0) {
                 fichaContribuyente.deducciones.push({ tercero: 'Entidad Financiera', concepto: 'Intereses Pagados', valor: data.interesesPagados, categoria: 'Costo/Gasto Procedente', estado: 'Pendiente', fuente: fileName });
            }
            if (data.aporteSalud > 0) {
                 fichaContribuyente.deducciones.push({ tercero: 'Sistema de Seguridad Social', concepto: 'Aporte a Salud', valor: data.aporteSalud, categoria: 'Deducción Salud', estado: 'Pendiente', fuente: fileName });
            }
            if (data.aportePension > 0) {
                 fichaContribuyente.deducciones.push({ tercero: 'Sistema de Seguridad Social', concepto: 'Aporte a Pensión', valor: data.aportePension, categoria: 'Aportes AFC/Pensiones', estado: 'Pendiente', fuente: fileName });
            }

            document.getElementById('ai-review-modal').classList.add('hidden');
            populateAllTables();
            showNotification(`Datos del archivo "${fileName}" guardados.`, 'success');
        }

        function displayNoDataFoundMessage() {
            const summaryContainer = document.getElementById('resumen');
            summaryContainer.innerHTML = ''; 
            const card = document.createElement('div');
            card.className = "bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 col-span-full";
            card.innerHTML = `<p class="font-bold">No se encontraron datos procesables</p><p>Se leyeron los archivos, pero no se pudo extraer información. Revisa que los archivos de Excel contengan columnas con los títulos: <strong>"Nombre / Razón Social", "Detalle", "Valor" y "Uso declaración Sugerida"</strong>.</p>`;
            document.getElementById('estados-financieros').innerHTML = card.outerHTML;
        }

        function parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            return parseFloat(value.replace(/\$\s*/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        function findHeaderIndex(data) {
            let bestCandidate = -1;
            let maxScore = 0;
            const minScoreThreshold = 3; 
            const keywords = ['nit', 'razón social', 'detalle', 'valor', 'uso declaración', 'tipo de documento', 'nit emisor'];
            data.slice(0, 20).forEach((row, index) => {
                if (!Array.isArray(row) || row.length < 5) return; 
                let score = 0;
                const rowStr = row.map(cell => String(cell || '')).join(' ').toLowerCase();
                keywords.forEach(key => {
                    if (rowStr.includes(key)) score++;
                });
                if (score > maxScore) {
                    maxScore = score;
                    bestCandidate = index;
                }
            });
            return maxScore >= minScoreThreshold ? bestCandidate : -1;
        }

        function processSheetData(data, fileName) {
            if (data.length < 1) return;
            const headerRowIndex = findHeaderIndex(data);
            if (headerRowIndex === -1) {
                console.error("Could not find a suitable header row in file:", fileName);
                return;
            }
            const headers = data[headerRowIndex].map(h => String(h || '').toLowerCase().trim());
            const rows = data.slice(headerRowIndex + 1);
            if (headers.includes('tipo de documento') && headers.includes('nit emisor')) {
                processDianReport(rows, headers, fileName);
            } else {
                processExogenaReport(rows, headers, fileName);
            }
        }

        function findContribuyenteNit(rows, nitReceptorIndex, nombreReceptorIndex) {
            if (fichaContribuyente.nit) return fichaContribuyente.nit;
            const nitCounts = {};
            let maxCount = 0;
            let contribuyenteNit = null;
            rows.slice(0, 50).forEach(row => { 
                if (row && row[nitReceptorIndex]) {
                    const nit = String(row[nitReceptorIndex]);
                    nitCounts[nit] = (nitCounts[nit] || 0) + 1;
                    if (nitCounts[nit] > maxCount) {
                        maxCount = nitCounts[nit];
                        contribuyenteNit = nit;
                    }
                }
            });
            if(contribuyenteNit) {
                const contribuyenteRow = rows.find(row => String(row[nitReceptorIndex]) === contribuyenteNit);
                if (contribuyenteRow) {
                    fichaContribuyente.nit = contribuyenteNit;
                    fichaContribuyente.nombre = String(contribuyenteRow[nombreReceptorIndex] || 'Nombre no encontrado');
                    updateContribuyenteInfoUI();
                }
            }
            return contribuyenteNit;
        }

        function processDianReport(rows, headers, fileName) {
            const colMap = {
                tipoDoc: headers.findIndex(h => h.includes('tipo de documento')),
                nitEmisor: headers.findIndex(h => h.includes('nit emisor')),
                nombreEmisor: headers.findIndex(h => h.includes('nombre emisor')),
                nitReceptor: headers.findIndex(h => h.includes('nit receptor')),
                nombreReceptor: headers.findIndex(h => h.includes('nombre receptor')),
                total: headers.findIndex(h => h.includes('total')),
                iva: headers.findIndex(h => h.includes('iva')),
                ica: headers.findIndex(h => h.includes('ica')),
                ic: headers.findIndex(h => h.includes('ic')),
                inc: headers.findIndex(h => h.includes('inc')),
                timbre: headers.findIndex(h => h.includes('timbre')),
                incBolsas: headers.findIndex(h => h.includes('inc bolsas')),
                inCarbono: headers.findIndex(h => h.includes('in carbono')),
                inCombustibles: headers.findIndex(h => h.includes('in combustibles')),
                icDatos: headers.findIndex(h => h.includes('ic datos')),
                icl: headers.findIndex(h => h.includes('icl')),
                inpp: headers.findIndex(h => h.includes('inpp')),
                ibua: headers.findIndex(h => h.includes('ibua')),
                icui: headers.findIndex(h => h.includes('icui')),
                reteIVA: headers.findIndex(h => h.includes('rete iva')),
                reteRenta: headers.findIndex(h => h.includes('rete renta')),
                reteICA: headers.findIndex(h => h.includes('rete ica')),
            };
            if ([colMap.tipoDoc, colMap.nitEmisor, colMap.nombreEmisor, colMap.nitReceptor, colMap.total].includes(-1)) {
                console.error(`DIAN report is missing required columns in file: ${fileName}.`);
                return;
            }
            const contribuyenteNit = findContribuyenteNit(rows, colMap.nitReceptor, colMap.nombreReceptor);
            if (!contribuyenteNit) {
                console.error(`Could not determine the main taxpayer's NIT in file: ${fileName}.`);
                return;
            }
            for (const row of rows) {
                if (!row || row.length === 0 || !row[colMap.total] || !row[colMap.tipoDoc]) {
                    continue;
                }
                const tipoDoc = String(row[colMap.tipoDoc] || '').toLowerCase(); 
                if (!tipoDoc) continue;
                const nitReceptor = String(row[colMap.nitReceptor] || '');
                const nitEmisor = String(row[colMap.nitEmisor] || '');
                const total = parseCurrency(row[colMap.total]);
                const impuestosYTretenciones = [
                    'iva', 'ica', 'ic', 'inc', 'timbre', 'incBolsas', 'inCarbono',
                    'inCombustibles', 'icDatos', 'icl', 'inpp', 'ibua', 'icui',
                    'reteIVA', 'reteRenta', 'reteICA'
                ].reduce((sum, key) => {
                    const colIndex = colMap[key];
                    const value = (colIndex !== -1 && row[colIndex]) ? parseCurrency(row[colIndex]) : 0;
                    return sum + value;
                }, 0);
                let subtotal = total - impuestosYTretenciones;
                if (tipoDoc.includes('nota crédito') || tipoDoc.includes('nota de crédito')) {
                    subtotal = -Math.abs(subtotal);
                }
                if (subtotal === 0) continue;
                if (nitReceptor === contribuyenteNit) {
                     if (tipoDoc.includes('soporte') || tipoDoc.includes('factura') || tipoDoc.includes('pos') || tipoDoc.includes('nota')) {
                        fichaContribuyente.deducciones.push({
                            tercero: String(row[colMap.nombreEmisor] || 'N/A'),
                            concepto: String(row[colMap.tipoDoc] || 'N/A'),
                            base: null,
                            valor: subtotal,
                            categoria: 'Costo/Gasto Procedente',
                            estado: 'Pendiente',
                            fuente: fileName
                        });
                    }
                } 
                else if (nitEmisor === contribuyenteNit) {
                    fichaContribuyente.ingresos.push({
                         tercero: String(row[colMap.nitReceptor] || 'N/A'),
                         concepto: String(row[colMap.tipoDoc] || 'N/A'),
                         valor: subtotal,
                         categoria: 'Renta no Laboral',
                         estado: 'Pendiente',
                         fuente: fileName
                    });
                }
            }
        }

        function processExogenaReport(rows, headers, fileName) {
             const colMap = {
                tercero: headers.findIndex(h => h && h.includes('nombre / razón social')),
                detalle: headers.findIndex(h => h && h.includes('detalle')),
                valor: headers.findIndex(h => h && h.includes('valor')),
                uso: headers.findIndex(h => h && h.includes('uso declaración sugerida'))
            };
            if (colMap.valor === -1 || colMap.detalle === -1) {
                console.error(`Exogena report is missing required columns ('Valor', 'Detalle') in file: ${fileName}.`);
                return;
            }
            for (const row of rows) {
                if (!row || row.length === 0 || !row[colMap.detalle]) {
                    continue;
                }
                const detalle = String(row[colMap.detalle] || '').toLowerCase();
                if (detalle.includes('monto total de facturación electrónica susceptible de beneficio')) {
                    const valorFacturacion = parseCurrency(row[colMap.valor]);
                    if (valorFacturacion > 0) {
                        const beneficio = valorFacturacion * 0.01;
                        fichaContribuyente.deducciones.push({
                            tercero: 'DIAN - Beneficio',
                            concepto: '1% Gasto por Facturación Electrónica',
                            valor: beneficio,
                            base: valorFacturacion,
                            categoria: 'Beneficio Facturación',
                            estado: 'Conciliado',
                            fuente: fileName
                        });
                    }
                }
                if (detalle.startsWith('tope ')) continue;
                const uso = colMap.uso !== -1 ? String(row[colMap.uso] || '').toLowerCase() : '';
                const valorRaw = row[colMap.valor];
                if (typeof valorRaw === 'string' && valorRaw.toLowerCase() === 'valor') continue;
                const valor = parseCurrency(valorRaw);
                const tercero = colMap.tercero !== -1 ? String(row[colMap.tercero] || 'N/A') : 'N/A';
                if (valor === 0 && !uso && !detalle) continue;
                if (uso.includes('r132')) {
                    fichaContribuyente.retenciones.push({ tercero, concepto: row[colMap.detalle], valor, estado: 'Pendiente', fuente: fileName });
                } else if (uso.includes('r29') || uso.includes('tope 2') || detalle.includes('saldo cdt') || detalle.includes('avalúo vehículo') || detalle.includes('cuenta por cobrar')) {
                    let tipo = 'Activo';
                    if (detalle.includes('deuda')) tipo = 'Pasivo';
                    
                    let categoria = 'Otros activos';
                    if (detalle.includes('saldo')) categoria = 'Bancos y efectivo';
                    if (detalle.includes('cdt')) categoria = 'Inversiones';
                    if (detalle.includes('vehículo')) categoria = 'Vehículos';
                    if (detalle.includes('inmueble')) categoria = 'Bienes inmuebles y/o acciones';

                    fichaContribuyente.patrimonio.push({ 
                        tipo: tipo, 
                        categoria: categoria,
                        descripcion: `${tercero} - ${row[colMap.detalle]}`, 
                        valor: valor, 
                        estado: 'Pendiente', 
                        fuente: fileName 
                    });

                } else if (uso.includes('r30')) {
                     fichaContribuyente.patrimonio.push({ tipo: 'Pasivo', categoria: 'Deudas', descripcion: `${tercero} - ${row[colMap.detalle]}`, valor: valor, estado: 'Pendiente', fuente: fileName });
                } else if (uso.includes('r74') || uso.includes('r58') || uso.includes('r43') || (uso.includes('tope 1') && !detalle.includes('costos'))) {
                    let categoria = 'Renta no Laboral';
                    if (uso.includes('r58') || detalle.includes('rendimientos')) categoria = 'Renta de Capital';
                    else if (uso.includes('r43') || detalle.includes('servicios')) categoria = 'Honorarios';
                    fichaContribuyente.ingresos.push({ tercero, concepto: row[colMap.detalle], valor, categoria, estado: 'Pendiente', fuente: fileName });
                } else if (detalle.includes('costos y deducciones')) {
                    fichaContribuyente.deducciones.push({ tercero, concepto: row[colMap.detalle], valor, categoria: 'Costo/Gasto Procedente', estado: 'Pendiente', fuente: fileName });
                } else if (uso.includes('r33') || detalle.includes('aporte pensión')) {
                     fichaContribuyente.deducciones.push({ tercero, concepto: row[colMap.detalle], valor, categoria: 'Aportes AFC/Pensiones', estado: 'Pendiente', fuente: fileName });
                }
            }
        }

        function getGroupStatusClass(statusCounts) {
            const total = statusCounts.Pendiente + statusCounts.Conciliado + statusCounts.Descartado;
            if (total === 0) return '';
            if (statusCounts.Conciliado > total / 2) return 'border-l-4 border-green-400';
            if (statusCounts.Pendiente > total / 2) return 'border-l-4 border-yellow-400';
            if (statusCounts.Descartado > total / 2) return 'border-l-4 border-red-400';
            if (statusCounts.Conciliado > 0) return 'border-l-4 border-green-400';
            if (statusCounts.Pendiente > 0) return 'border-l-4 border-yellow-400';
            if (statusCounts.Descartado > 0) return 'border-l-4 border-red-400';
            return '';
        }

        function populateAllTables() {
            populateTable('ingresos', ['tercero', 'concepto', 'valor', 'categoria', 'estado', 'fuente']);
            populateTable('deducciones', ['tercero', 'concepto', 'base', 'valor', 'categoria', 'estado', 'fuente']);
            populateTable('patrimonio', ['tipo', 'categoria', 'descripcion', 'valor', 'estado', 'fuente']);
            populateTable('retenciones', ['tercero', 'concepto', 'valor', 'estado', 'fuente']);
            updateSummary();
            renderOverallSummary();
            renderFinancialStatements();
            populateArchivosTab();
        }

        function populateArchivosTab() {
            const tbody = document.getElementById('archivos-body');
            tbody.innerHTML = '';
            fichaContribuyente.documentos.forEach(doc => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-700">${doc.file.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${doc.uploadedAt.toLocaleString('es-CO')}</td>
                    <td class="px-6 py-4 text-sm"><button class="delete-file-btn text-red-500 hover:text-red-700 font-medium" data-filename="${doc.file.name}">Eliminar</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateTable(type, columns) {
            const tbody = document.getElementById(`${type}-body`);
            const data = fichaContribuyente[type];
            tbody.innerHTML = '';
            if ((type === 'ingresos' || type === 'deducciones') && data.length > 0) {
                const groupedData = Object.values(data.reduce((acc, item) => {
                    const key = `${item.concepto || 'Sin Concepto'}|${item.fuente || 'Sin Fuente'}`;
                    if (!acc[key]) {
                        acc[key] = {
                            concepto: item.concepto || 'Sin Concepto',
                            fuente: item.fuente || 'Sin Fuente',
                            totalValor: 0,
                            items: []
                        };
                    }
                    acc[key].totalValor += item.valor;
                    acc[key].items.push(item);
                    return acc;
                }, {}));
                groupedData.forEach((group, index) => {
                    const groupId = `${type}-group-${index}`;
                    const statusCounts = { Pendiente: 0, Conciliado: 0, Descartado: 0 };
                    group.items.forEach(item => { statusCounts[item.estado]++; });
                    const groupStatusClass = getGroupStatusClass(statusCounts);
                    const isGroupNew = group.items.some(item => item.fuente === latestFileName);
                    const newGroupIndicator = isGroupNew ? '<span class="inline-block w-2 h-2 mr-2 bg-blue-500 rounded-full animate-pulse"></span>' : '';
                    const groupHeaderRow = tbody.insertRow();
                    groupHeaderRow.className = `bg-gray-50 cursor-pointer hover:bg-gray-100 group-header border-b border-gray-200`;
                    groupHeaderRow.dataset.groupId = groupId;
                    const descCell = groupHeaderRow.insertCell();
                    descCell.className = `px-6 py-3 text-left ${groupStatusClass}`;
                    descCell.innerHTML = `
                        <div class="flex items-center">
                            ${newGroupIndicator}
                            <svg class="w-5 h-5 mr-3 text-blue-500 transition-transform duration-200 transform group-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            <div>
                                <span class="font-bold text-gray-800">${group.concepto}</span>
                                <span class="block text-xs text-gray-500">${group.fuente}</span>
                            </div>
                        </div>`;
                    const valCell = groupHeaderRow.insertCell();
                    valCell.className = 'px-6 py-3 text-right font-mono font-bold text-gray-800';
                    valCell.innerHTML = `
                        <div class="flex items-center justify-end space-x-4">
                            <span>${formatCurrency(group.totalValor)}</span>
                             <div class="flex items-center rounded-full bg-gray-200 p-0.5 space-x-1">
                                 <button class="status-group-btn bg-yellow-400 text-white hover:bg-yellow-500 text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center transition-transform transform hover:scale-110" title="Marcar como Pendiente"
                                        data-type="${type}" data-concepto="${group.concepto}" data-fuente="${group.fuente}" data-status="Pendiente">P</button>
                                 <button class="status-group-btn bg-green-500 text-white hover:bg-green-600 text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center transition-transform transform hover:scale-110" title="Marcar como Conciliado"
                                        data-type="${type}" data-concepto="${group.concepto}" data-fuente="${group.fuente}" data-status="Conciliado">C</button>
                                 <button class="status-group-btn bg-red-500 text-white hover:bg-red-600 text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center transition-transform transform hover:scale-110" title="Marcar como Descartado"
                                        data-type="${type}" data-concepto="${group.concepto}" data-fuente="${group.fuente}" data-status="Descartado">D</button>
                            </div>
                        </div>
                    `;
                    const detailContainerRow = tbody.insertRow();
                    detailContainerRow.className = 'hidden detail-container';
                    detailContainerRow.dataset.groupId = groupId;
                    const detailCell = detailContainerRow.insertCell();
                    detailCell.colSpan = 2;
                    detailCell.className = 'p-0';
                    const subTable = document.createElement('table');
                    subTable.className = 'min-w-full';
                    const subThead = subTable.createTHead();
                    subThead.className = 'bg-white';
                    const subHeaderRow = subThead.insertRow();
                    const groupCategoryOptions = categorias[type].map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    const groupCategorySelectorHTML = `
                        <select class="group-category-selector w-full bg-transparent border-none focus:ring-0 focus:outline-none p-1 rounded-md hover:bg-gray-100 text-xs font-medium text-gray-500 uppercase tracking-wider"
                                data-type="${type}" data-concepto="${group.concepto}" data-fuente="${group.fuente}">
                            <option value="">-- Asignar a Todos --</option>
                            ${groupCategoryOptions}
                        </select>`;
                    let headerHTML = '';
                    if (type === 'ingresos') {
                        headerHTML = `<th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tercero</th><th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${groupCategorySelectorHTML}</th><th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>`;
                    } else {
                        headerHTML = `<th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tercero</th><th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${groupCategorySelectorHTML}</th><th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th><th class="px-6 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Base</th><th class="px-6 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>`;
                    }
                    subHeaderRow.innerHTML = headerHTML;
                    const subTbody = subTable.createTBody();
                    group.items.forEach(item => {
                        const row = subTbody.insertRow();
                        row.className = "bg-white hover:bg-gray-50";
                        let cellsHTML = '';
                        const isItemNew = item.fuente === latestFileName;
                        const newItemIndicator = isItemNew ? '<span class="inline-block w-2 h-2 mr-2 bg-blue-500 rounded-full"></span>' : '';
                        if (type === 'ingresos') {
                            cellsHTML = `
                                <td class="px-6 py-3 text-sm text-gray-700 border-t">${newItemIndicator}${item.tercero || ''}</td>
                                <td class="px-6 py-3 text-sm text-gray-700 border-t">${createCategorySelector(type, item.categoria)}</td>
                                <td class="px-6 py-3 text-sm text-gray-700 border-t">${createStatusSelector(item.estado)}</td>
                                <td class="px-6 py-3 text-sm text-gray-700 border-t text-right font-mono">${formatCurrency(item.valor)}</td>`;
                        } else {
                            cellsHTML = `
                                <td class="px-6 py-3 text-sm text-gray-700 border-t">${newItemIndicator}${item.tercero || ''}</td>
                                <td class="px-6 py-3 text-sm text-gray-700 border-t">${createCategorySelector(type, item.categoria)}</td>
                                <td class="px-6 py-3 text-sm text-gray-700 border-t">${createStatusSelector(item.estado)}</td>
                                <td class="px-6 py-3 text-sm text-gray-500 border-t text-right font-mono">${item.base ? formatCurrency(item.base) : ''}</td>
                                <td class="px-6 py-3 text-sm text-gray-700 border-t text-right font-mono">${formatCurrency(item.valor)}</td>`;
                        }
                        row.innerHTML = cellsHTML;
                        addSelectListeners(row, item);
                    });
                    detailCell.appendChild(subTable);

                    if (expandedGroupIds.has(groupId)) {
                        detailContainerRow.classList.remove('hidden');
                        const arrow = groupHeaderRow.querySelector('.group-arrow');
                        if (arrow) arrow.classList.add('rotate-90');
                    }
                });
            } else {
                 data.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 transition-colors";
                    let cells = '';
                    const isNew = item.fuente === latestFileName;
                    const newIndicator = isNew ? '<span class="inline-block w-2 h-2 mr-2 bg-blue-500 rounded-full"></span>' : '';
                    columns.forEach((col, index) => {
                        let content = item[col];
                        let cellClass = 'px-6 py-4 text-sm text-gray-700';
                        let finalContent = '';
                        if (col === 'valor' || col === 'valorfiscal') {
                            finalContent = formatCurrency(content);
                            cellClass += ' text-right font-mono';
                        } else if (col === 'base') {
                            finalContent = item.base ? formatCurrency(item.base) : '';
                            cellClass += ' text-right font-mono text-gray-500';
                        } else if (col === 'categoria') {
                            finalContent = createCategorySelector(type, content);
                        } else if (col === 'estado') {
                            finalContent = createStatusSelector(content);
                        } else if (col === 'fuente') {
                            finalContent = content || '';
                            cellClass = 'px-6 py-4 text-xs text-gray-500';
                        } else {
                            finalContent = content || '';
                        }
                        
                        // Add new indicator to the correct column
                        if ((type === 'patrimonio' && index === 2) || (type !== 'patrimonio' && index === 0)) {
                             cells += `<td class="${cellClass}">${newIndicator}${finalContent}</td>`;
                        }
                        else {
                            cells += `<td class="${cellClass}">${finalContent}</td>`;
                        }
                    });
                    row.innerHTML = cells;
                    tbody.appendChild(row);
    
                    addSelectListeners(row, item);
                });
            }
        }
        
        function addSelectListeners(row, item) {
             const statusSelect = row.querySelector('select.status-badge');
            if (statusSelect) {
                statusSelect.addEventListener('change', (event) => {
                    item.estado = event.target.value;
                    populateAllTables();
                });
            }
            const categorySelect = row.querySelector('select:not(.status-badge)');
            if (categorySelect) {
                categorySelect.addEventListener('change', (event) => {
                    item.categoria = event.target.value;
                     if (item.tipo === 'Pasivo') {
                        item.categoria = 'Deudas';
                    }
                    populateAllTables();
                });
            }
        }
        
        function createCategorySelector(type, selectedCategory) {
            if (!categorias[type] || (type === 'patrimonio' && selectedCategory === 'Deudas')) return selectedCategory || '';

            let options = categorias[type].map(cat => `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`).join('');
            
            return `<select class="w-full bg-transparent border-none focus:ring-0 focus:outline-none p-1 rounded-md hover:bg-gray-100">${options}</select>`;
        }

        function createStatusSelector(selectedStatus) {
            const options = estados.map(stat => `<option value="${stat}" ${stat === selectedStatus ? 'selected' : ''}>${stat}</option>`).join('');
            const statusClass = `status-${selectedStatus.toLowerCase()}`;
            return `<select class="w-full bg-transparent border-none focus:ring-0 focus:outline-none p-1 ${statusClass} status-badge">${options}</select>`;
        }
        
        function createSummaryCard(title, value, container, customClasses = '') {
            const card = document.createElement('div');
            card.className = `bg-gray-50 p-4 rounded-lg border ${customClasses}`;
            const valueColor = customClasses.includes('text-red-600') ? 'text-red-600' : 'text-gray-800';
            card.innerHTML = `<p class="text-sm text-gray-600">${title}</p><p class="text-xl font-bold ${valueColor}">${formatCurrency(value)}</p>`;
            container.appendChild(card);
        }

        function renderFinancialStatements() {
            const container = document.getElementById('estados-financieros');
            container.innerHTML = '';

            const patrimonioConciliado = fichaContribuyente.patrimonio.filter(item => item.estado === 'Conciliado');
            const activos = patrimonioConciliado.filter(item => item.tipo === 'Activo');
            const pasivos = patrimonioConciliado.filter(item => item.tipo === 'Pasivo');

            const activosByCategory = activos.reduce((acc, item) => {
                const key = item.categoria || 'Otros activos';
                if (!acc[key]) acc[key] = { items: [], total: 0 };
                acc[key].items.push(item);
                acc[key].total += item.valor;
                return acc;
            }, {});

            const totalActivosBruto = activos.reduce((sum, item) => sum + item.valor, 0);
            const totalPasivos = pasivos.reduce((sum, item) => sum + item.valor, 0);
            const patrimonioLiquido = totalActivosBruto - totalPasivos;

            const ingresosConciliados = fichaContribuyente.ingresos.filter(item => item.estado === 'Conciliado');
            const totalIngresos = ingresosConciliados.reduce((sum, item) => sum + item.valor, 0);
            
            const ingresosByCatAndConcept = ingresosConciliados.reduce((acc, item) => {
                const categoria = item.categoria || 'Otro';
                const concepto = item.concepto || 'Sin Concepto';
                if (!acc[categoria]) {
                    acc[categoria] = { total: 0, conceptos: {} };
                }
                acc[categoria].total += item.valor;
                if (!acc[categoria].conceptos[concepto]) {
                    acc[categoria].conceptos[concepto] = 0;
                }
                acc[categoria].conceptos[concepto] += item.valor;
                return acc;
            }, {});

            const deduccionesConciliadas = fichaContribuyente.deducciones.filter(item => item.estado === 'Conciliado');
            const totalDeducciones = deduccionesConciliadas.reduce((sum, item) => sum + item.valor, 0);

            const deduccionesByCatAndConcept = deduccionesConciliadas.reduce((acc, item) => {
                const categoria = item.categoria || 'Otro';
                const concepto = item.concepto || 'Sin Concepto';
                if (!acc[categoria]) {
                    acc[categoria] = { total: 0, conceptos: {} };
                }
                acc[categoria].total += item.valor;
                if (!acc[categoria].conceptos[concepto]) {
                    acc[categoria].conceptos[concepto] = 0;
                }
                acc[categoria].conceptos[concepto] += item.valor;
                return acc;
            }, {});

            const utilidad = totalIngresos - totalDeducciones;

            const renderAssetCategory = (categoryName) => {
                const categoryData = activosByCategory[categoryName];
                if (!categoryData || categoryData.items.length === 0) return '';
                
                let itemsHtml = categoryData.items.map(item => `
                    <div class="flex justify-between items-center text-gray-500 text-sm">
                        <p class="truncate pr-4" title="${item.descripcion}">${item.descripcion}</p>
                        <p class="font-mono whitespace-nowrap">${formatCurrency(item.valor)}</p>
                    </div>
                `).join('');

                return `
                    <div class="flex justify-between items-center font-semibold text-gray-700">
                        <p>${categoryName}</p>
                        <p class="font-mono">${formatCurrency(categoryData.total)}</p>
                    </div>
                    <div class="pl-4 space-y-1 border-l-2 ml-2 py-1">${itemsHtml}</div>
                `;
            };

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Estado de Resultado -->
                    <div class="p-6 border rounded-lg bg-white shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Estado de Resultado</h3>
                        <div class="space-y-3 text-base">
                            <div class="flex justify-between items-center font-semibold">
                                <p class="text-gray-700">Ingresos</p>
                                <p class="font-mono text-gray-900">${formatCurrency(totalIngresos)}</p>
                            </div>
                            <div class="pl-4 space-y-2 text-sm border-l-2 ml-2 py-1">
                                ${Object.keys(ingresosByCatAndConcept).sort().map(cat => `
                                    <div class="pt-1">
                                        <div class="flex justify-between items-center text-gray-700 font-semibold">
                                            <p>${cat}</p>
                                            <p class="font-mono">${formatCurrency(ingresosByCatAndConcept[cat].total)}</p>
                                        </div>
                                        <div class="pl-4">
                                            ${Object.keys(ingresosByCatAndConcept[cat].conceptos).sort().map(concepto => `
                                                <div class="flex justify-between items-center text-gray-500 text-xs">
                                                    <p class="truncate pr-2">${concepto}</p>
                                                    <p class="font-mono whitespace-nowrap">${formatCurrency(ingresosByCatAndConcept[cat].conceptos[concepto])}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-between items-center font-semibold mt-4">
                                <p class="text-gray-700">(-) Costos y Deducciones</p>
                                <p class="font-mono text-gray-900">${formatCurrency(totalDeducciones)}</p>
                            </div>
                            <div class="pl-4 space-y-2 text-sm border-l-2 ml-2 py-1">
                                ${Object.keys(deduccionesByCatAndConcept).sort().map(cat => `
                                     <div class="pt-1">
                                        <div class="flex justify-between items-center text-gray-700 font-semibold">
                                            <p>${cat}</p>
                                            <p class="font-mono">${formatCurrency(deduccionesByCatAndConcept[cat].total)}</p>
                                        </div>
                                        <div class="pl-4">
                                            ${Object.keys(deduccionesByCatAndConcept[cat].conceptos).sort().map(concepto => `
                                                <div class="flex justify-between items-center text-gray-500 text-xs">
                                                    <p class="truncate pr-2">${concepto}</p>
                                                    <p class="font-mono whitespace-nowrap">${formatCurrency(deduccionesByCatAndConcept[cat].conceptos[concepto])}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-between items-center border-t pt-3 mt-3">
                                <p class="font-bold text-gray-800">Utilidad / Pérdida</p>
                                <p class="font-mono font-bold text-xl ${utilidad >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(utilidad)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Estado de Situación Financiera -->
                    <div class="p-6 border rounded-lg bg-white shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Estado de Situación Financiera</h3>
                        <div class="space-y-3 text-base">
                            ${categorias.patrimonio.map(renderAssetCategory).join('')}
                             <div class="flex justify-between items-center border-t pt-3 mt-3">
                                <p class="font-bold text-gray-800">Total Patrimonio Bruto</p>
                                <p class="font-mono font-bold text-lg text-blue-600">${formatCurrency(totalActivosBruto)}</p>
                            </div>
                             <div class="flex justify-between items-center font-semibold mt-4 text-gray-700">
                                <p>(-) Deudas</p>
                                <p class="font-mono">${formatCurrency(totalPasivos)}</p>
                            </div>
                            <div class="pl-4 space-y-1 text-sm border-l-2 ml-2 py-1">
                                ${pasivos.map(item => `
                                    <div class="flex justify-between items-center text-gray-500">
                                        <p class="truncate pr-4" title="${item.descripcion}">${item.descripcion}</p><p class="font-mono whitespace-nowrap">${formatCurrency(item.valor)}</p>
                                    </div>`).join('')}
                            </div>
                            <div class="flex justify-between items-center border-t-2 border-double pt-3 mt-3">
                                <p class="font-bold text-gray-800 text-lg">Total Patrimonio Líquido</p>
                                <p class="font-mono font-bold text-xl text-blue-800">${formatCurrency(patrimonioLiquido)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            if (totalActivosBruto === 0 && totalPasivos === 0 && totalIngresos === 0 && totalDeducciones === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-10">
                    <h3 class="text-lg font-semibold">No hay datos conciliados.</h3>
                    <p>Concilia ítems para generar los estados financieros.</p>
                </div>`;
            } else {
                container.innerHTML = html;
            }
        }

        function renderOverallSummary() {
            const container = document.getElementById('resumen');
            container.innerHTML = '';
            const ingresosConciliados = fichaContribuyente.ingresos.filter(item => item.estado === 'Conciliado');
            if (ingresosConciliados.length > 0) {
                const totalIngresos = ingresosConciliados.reduce((sum, item) => sum + item.valor, 0);
                const byCategory = ingresosConciliados.reduce((acc, item) => {
                    const key = item.categoria || 'Otro';
                    if (!acc[key]) acc[key] = 0;
                    acc[key] += item.valor;
                    return acc;
                }, {});
                let ingresosHtml = `<div class="p-4 border rounded-lg">
                    <div class="flex justify-between items-baseline mb-2 pb-2 border-b">
                        <h3 class="text-lg font-semibold text-gray-700">INGRESOS</h3>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(totalIngresos)}</p>
                    </div><div class="space-y-1 text-sm">`;
                Object.keys(byCategory).sort().forEach(cat => {
                    ingresosHtml += `<div class="flex justify-between items-baseline text-gray-600">
                        <p class="pl-4">${cat.toUpperCase()}</p>
                        <p class="font-mono">${formatCurrency(byCategory[cat])}</p>
                    </div>`;
                });
                ingresosHtml += `</div></div>`;
                container.innerHTML += ingresosHtml;
            }
            const deduccionesConciliadas = fichaContribuyente.deducciones.filter(item => item.estado === 'Conciliado');
            if (deduccionesConciliadas.length > 0) {
                const totalDeducciones = deduccionesConciliadas.reduce((sum, item) => sum + item.valor, 0);
                const byCategory = deduccionesConciliadas.reduce((acc, item) => {
                    const key = item.categoria || 'Otro';
                    if (!acc[key]) acc[key] = 0;
                    acc[key] += item.valor;
                    return acc;
                }, {});
                let deduccionesHtml = `<div class="p-4 border rounded-lg">
                    <div class="flex justify-between items-baseline mb-2 pb-2 border-b">
                        <h3 class="text-lg font-semibold text-gray-700">COSTOS Y DEDUCCIONES</h3>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(totalDeducciones)}</p>
                    </div><div class="space-y-1 text-sm">`;
                Object.keys(byCategory).sort().forEach(cat => {
                    deduccionesHtml += `<div class="flex justify-between items-baseline text-gray-600">
                        <p class="pl-4">${cat.toUpperCase()}</p>
                        <p class="font-mono">${formatCurrency(byCategory[cat])}</p>
                    </div>`;
                });
                deduccionesHtml += `</div></div>`;
                container.innerHTML += deduccionesHtml;
            }
            const patrimonioConciliado = fichaContribuyente.patrimonio.filter(item => item.estado === 'Conciliado');
              if (patrimonioConciliado.length > 0) {
                const totalActivos = patrimonioConciliado.filter(item => item.tipo !== 'Pasivo').reduce((sum, item) => sum + item.valor, 0);
                const totalPasivos = patrimonioConciliado.filter(item => item.tipo === 'Pasivo').reduce((sum, item) => sum + item.valor, 0);
                const patrimonioLiquido = totalActivos - totalPasivos;
                let patrimonioHtml = `<div class="p-4 border rounded-lg">
                    <div class="flex justify-between items-baseline mb-2 pb-2 border-b">
                        <h3 class="text-lg font-semibold text-gray-700">PATRIMONIO</h3>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(patrimonioLiquido)}</p>
                    </div><div class="space-y-1 text-sm">
                        <div class="flex justify-between items-baseline text-gray-600"><p class="pl-4">TOTAL ACTIVOS</p><p class="font-mono">${formatCurrency(totalActivos)}</p></div>
                        <div class="flex justify-between items-baseline text-gray-600"><p class="pl-4">TOTAL PASIVOS</p><p class="font-mono">${formatCurrency(totalPasivos)}</p></div>
                    </div></div>`;
                container.innerHTML += patrimonioHtml;
            }
            const retencionesConciliadas = fichaContribuyente.retenciones.filter(item => item.estado === 'Conciliado');
              if (retencionesConciliadas.length > 0) {
                const totalRetenciones = retencionesConciliadas.reduce((sum, item) => sum + item.valor, 0);
                let retencionesHtml = `<div class="p-4 border rounded-lg">
                    <div class="flex justify-between items-baseline">
                        <h3 class="text-lg font-semibold text-gray-700">RETENCIONES</h3>
                        <p class="text-lg font-bold text-gray-900">${formatCurrency(totalRetenciones)}</p>
                    </div></div>`;
                container.innerHTML += retencionesHtml;
            }
            if (container.innerHTML.trim() === '') {
                 container.innerHTML = `<div class="text-center text-gray-500 py-10">
                    <h3 class="text-lg font-semibold">No hay datos conciliados.</h3>
                    <p>Cambia el estado de los ítems en las otras pestañas a "Conciliado" para ver el resumen aquí.</p>
                </div>`;
            }
        }

        function updateSummary() {
            const activeTab = document.querySelector('.tab-active')?.dataset.tab;
            if (!activeTab || activeTab === 'resumen' || activeTab === 'estados-financieros') return;
            const summaryContainerEl = document.getElementById(`${activeTab}-summary`);
            if (!summaryContainerEl) return;
            const summaryTitle = document.createElement('h2');
            summaryTitle.className = "text-xl font-semibold text-gray-700 mb-4";
            const gridContainer = document.createElement('div');
            gridContainer.className = "grid grid-cols-2 md:grid-cols-4 gap-4";
            summaryContainerEl.innerHTML = '';
            summaryContainerEl.appendChild(summaryTitle);
            summaryContainerEl.appendChild(gridContainer);
            switch (activeTab) {
                case 'ingresos': {
                    summaryTitle.textContent = 'Resumen de Ingresos Conciliados';
                    const reconciledItems = fichaContribuyente.ingresos.filter(item => item.estado === 'Conciliado');
                    const total = reconciledItems.reduce((sum, item) => sum + item.valor, 0);
                    createSummaryCard('Total Ingresos', total, gridContainer, 'col-span-full md:col-span-2');
                    const byCategory = reconciledItems.reduce((acc, item) => {
                        const key = item.categoria || 'Otro';
                        if (!acc[key]) acc[key] = 0;
                        acc[key] += item.valor;
                        return acc;
                    }, {});
                    Object.keys(byCategory).sort().forEach(categoria => createSummaryCard(categoria, byCategory[categoria], gridContainer));
                    break;
                }
                case 'deducciones': {
                    summaryTitle.textContent = 'Resumen de Costos y Deducciones Conciliados';
                    const reconciledItems = fichaContribuyente.deducciones.filter(item => item.estado === 'Conciliado');
                    const total = reconciledItems.reduce((sum, item) => sum + item.valor, 0);
                    createSummaryCard('Total Deducciones', total, gridContainer, 'col-span-full md:col-span-2');
                    const byCategory = reconciledItems.reduce((acc, item) => {
                        const key = item.categoria || 'Otro';
                        if (!acc[key]) acc[key] = 0;
                        acc[key] += item.valor;
                        return acc;
                    }, {});
                    Object.keys(byCategory).sort().forEach(categoria => createSummaryCard(categoria, byCategory[categoria], gridContainer));
                    break;
                }
                case 'retenciones': {
                    summaryTitle.textContent = 'Resumen de Retenciones Conciliadas';
                    const reconciledItems = fichaContribuyente.retenciones.filter(item => item.estado === 'Conciliado');
                    const total = reconciledItems.reduce((sum, item) => sum + item.valor, 0);
                    createSummaryCard('Total Retenciones', total, gridContainer, 'col-span-full');
                    break;
                }
                case 'patrimonio': {
                    summaryTitle.textContent = 'Resumen de Patrimonio Conciliado';
                    const reconciledItems = fichaContribuyente.patrimonio.filter(item => item.estado === 'Conciliado');
                    const totalActivos = reconciledItems.filter(item => item.tipo !== 'Pasivo').reduce((sum, item) => sum + item.valor, 0);
                    const totalPasivos = reconciledItems.filter(item => item.tipo === 'Pasivo').reduce((sum, item) => sum + item.valor, 0);
                    const patrimonioLiquido = totalActivos - totalPasivos;
                    createSummaryCard('Total Activos', totalActivos, gridContainer, 'col-span-full sm:col-span-1');
                    createSummaryCard('Total Pasivos', totalPasivos, gridContainer, 'col-span-full sm:col-span-1');
                    createSummaryCard('Patrimonio Líquido', patrimonioLiquido, gridContainer, 'col-span-full sm:col-span-2');
                    break;
                }
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(value);
        }
    </script>
</body>
</html>

